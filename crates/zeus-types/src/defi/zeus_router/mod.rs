use alloy::{
    primitives::{ Address, Bytes, U256},
    sol,
};
use revm::primitives::Bytecode;
use alloy::core::sol_types::SolCall;
use std::str::FromStr;
use lazy_static::lazy_static;

lazy_static! {
    // TODO
    pub static ref SWAP_ROUTER_ADDR: Address = Address::from_str("0x0000000000000000000000000000000000000000").unwrap();
    pub static ref SWAP_ROUTER_CODE: Bytes = "0x608060408181526004908136101561001657600080fd5b600092833560e01c90816323a50d3c14610a2d57508063ac20c2ca146102125763fa461e331461004557600080fd5b3461020e57606036600319011261020e576044359067ffffffffffffffff80831161020657366023840112156102065782840135908111610206578201366024820111610206578260a091031261020a5760248201358015158103610206576100b060448401610ac4565b906100bd60648501610ac4565b9260a46100cc60848701610ac4565b9501359262ffffff84168094036101f0576001600160a01b0380809216961693818351967f1698ee82000000000000000000000000000000000000000000000000000000008852888a8901521660248701526044860152602085606481731f98431c8ad98523631ae4a59f267346ea31f9845afa9485156101fc5788956101bb575b508416330361017957501561016b57610168933592610b75565b80f35b610168935060243592610b75565b5162461bcd60e51b8152602081870152600c60248201527f4e6f742074686520706f6f6c00000000000000000000000000000000000000006044820152606490fd5b9094506020813d6020116101f4575b816101d760209383610ad8565b810103126101f0575184811681036101f057933861014e565b8780fd5b3d91506101ca565b82513d8a823e3d90fd5b8480fd5b8380fd5b8280fd5b503461020e5760c036600319011261020e576001600160a01b039182610236610b10565b16938251809581957f70a082310000000000000000000000000000000000000000000000000000000091828452338685015260209889916024998a915afa928315610a235784936109f4575b506084358061076c57506102ac81610298610b26565b166102a1610b3c565b604435913390610b75565b846060826102b8610b3c565b168851928380927f0902f1ac0000000000000000000000000000000000000000000000000000000082525afa9081156107625785908692610708575b506dffffffffffffffffffffffffffff9182169116610311610b26565b838061031b610b10565b169116101561070357905b8261032f610b26565b168a848b61033b610b3c565b8c5194859384928b8452168d8301525afa80156106f957839088906106c4575b6103659250610b52565b801561065d578215801580610654575b156105ed576103e58083029280840482036105db578402029282840414821517156105c9576103e88085029485041417156105b75782018092116105a557811561059357046103c2610b26565b82806103cc610b10565b169116101561058c57845b826103e0610b3c565b168851918b83019267ffffffffffffffff938181108582111761057a578b52888152823b1561057657918b91898b61045c82968f51998a97889687957f022c0d9f000000000000000000000000000000000000000000000000000000008752860152840152336044840152608060648401526084830190610cdb565b03925af1801561056c57908a939291610543575b505061047a610b10565b169187875180948193825233898301525afa908115610539578391610507575b50915b508015610500576104ad91610b52565b925b60a43584106104c057505051908152f35b601e9085606494519362461bcd60e51b85528401528201527f5265616c20416d6f756e74203c204d696e696d756d20526563656976656400006044820152fd5b50926104af565b90508681813d8311610532575b61051e8183610ad8565b8101031261052d57513861049a565b600080fd5b503d610514565b85513d85823e3d90fd5b9080929693501161055a5786529287903880610470565b8782604188634e487b7160e01b835252fd5b88513d88823e3d90fd5b8880fd5b8c8a60418d634e487b7160e01b835252fd5b84906103d7565b8886601289634e487b7160e01b835252fd5b8886601189634e487b7160e01b835252fd5b898760118a634e487b7160e01b835252fd5b8a8860118b634e487b7160e01b835252fd5b8c8a60118d634e487b7160e01b835252fd5b60848960288d8f8e519362461bcd60e51b85528401528201527f556e697377617056324c6962726172793a20494e53554646494349454e545f4c60448201527f49515549444954590000000000000000000000000000000000000000000000006064820152fd5b50821515610375565b608488602b8c8e8d519362461bcd60e51b85528401528201527f556e697377617056324c6962726172793a20494e53554646494349454e545f4960448201527f4e5055545f414d4f554e540000000000000000000000000000000000000000006064820152fd5b50508a81813d83116106f2575b6106db8183610ad8565b810103126106ee5782610365915161035b565b8680fd5b503d6106d1565b89513d89823e3d90fd5b610326565b9150506060813d60601161075a575b8161072460609383610ad8565b810103126102065761073581610d1b565b876107418b8401610d1b565b92015163ffffffff81160361075657386102f4565b8580fd5b3d9150610717565b87513d87823e3d90fd5b6001036109b35761077b610b26565b8180610785610b10565b16911610801561099857856401000276ad5b8a846107a1610b3c565b168a51938480927fddca3f430000000000000000000000000000000000000000000000000000000082525afa9182156106f957908b939291889261095a575b5062ffffff856107ee610b3c565b1692866107f9610b26565b8d82610803610b10565b928983519b8c015216908901521660608701523360808701521660a085015260a0845260c084019284841067ffffffffffffffff85111761094857838b527f128acb080000000000000000000000000000000000000000000000000000000084523360c486015260e4850152604435610104850152841661012484015260a061014484015288908290818960bf19876108a0610164820182610cdb565b0301925af1801561056c579188918b9493610915575b5050506108c1610b10565b169187875180948193825233898301525afa9081156105395783916108e8575b509161049d565b90508681813d831161090e575b6108ff8183610ad8565b8101031261020e5751386108e1565b503d6108f5565b909180939450903d8411610940575b8161092e91610ad8565b8101031261020a5787908638806108b6565b3d9150610924565b8b8960418c634e487b7160e01b835252fd5b809250849193943d8311610991575b6109738183610ad8565b810103126106ee575162ffffff811681036106ee578a9291386107e0565b503d610969565b8573fffd8963efd1fc6a506488495d951d5263988d25610797565b6064856014898b8a519362461bcd60e51b85528401528201527f496e76616c696420706f6f6c2076617269616e740000000000000000000000006044820152fd5b9092508781813d8311610a1c575b610a0c8183610ad8565b8101031261020a57519138610282565b503d610a02565b86513d86823e3d90fd5b905083913461020e578060031936011261020e578335906001600160a01b03821680920361020a577fa9059cbb000000000000000000000000000000000000000000000000000000006020840152336024840152602435604484015260448352608083019083821067ffffffffffffffff831117610ab15761016894955052610be6565b602485604188634e487b7160e01b835252fd5b35906001600160a01b038216820361052d57565b90601f8019910116810190811067ffffffffffffffff821117610afa57604052565b634e487b7160e01b600052604160045260246000fd5b6024356001600160a01b038116810361052d5790565b6004356001600160a01b038116810361052d5790565b6064356001600160a01b038116810361052d5790565b91908203918211610b5f57565b634e487b7160e01b600052601160045260246000fd5b9290604051927f23b872dd0000000000000000000000000000000000000000000000000000000060208501526001600160a01b03809216602485015216604483015260648201526064815260a081019181831067ffffffffffffffff841117610afa57610be492604052610be6565b565b6001600160a01b031690600080826020829451910182865af13d15610ccf573d9067ffffffffffffffff8211610cbb5790610c439160405191610c336020601f19601f8401160184610ad8565b82523d84602084013e5b84610d36565b908151918215159283610c8c575b505050610c5b5750565b602490604051907f5274afe70000000000000000000000000000000000000000000000000000000082526004820152fd5b819293509060209181010312610cb7576020015190811591821503610cb45750388080610c51565b80fd5b5080fd5b602483634e487b7160e01b81526041600452fd5b610c4390606090610c3d565b919082519283825260005b848110610d07575050826000602080949584010152601f8019910116010190565b602081830181015184830182015201610ce6565b51906dffffffffffffffffffffffffffff8216820361052d57565b90610d755750805115610d4b57805190602001fd5b60046040517f1425ea42000000000000000000000000000000000000000000000000000000008152fd5b81511580610dc0575b610d86575090565b6024906001600160a01b03604051917f9996b315000000000000000000000000000000000000000000000000000000008352166004820152fd5b50803b15610d7e56fea2646970667358221220b4aac17a7b8f27154691ef1ddd0413eec81dde7ad9dc0552efb1dd2802cd10b364736f6c63430008170033".parse().unwrap();
}

sol! {
            #[sol(bytecode="0x608060408181526004908136101561001657600080fd5b600092833560e01c90816323a50d3c14610a2d57508063ac20c2ca146102125763fa461e331461004557600080fd5b3461020e57606036600319011261020e576044359067ffffffffffffffff80831161020657366023840112156102065782840135908111610206578201366024820111610206578260a091031261020a5760248201358015158103610206576100b060448401610ac4565b906100bd60648501610ac4565b9260a46100cc60848701610ac4565b9501359262ffffff84168094036101f0576001600160a01b0380809216961693818351967f1698ee82000000000000000000000000000000000000000000000000000000008852888a8901521660248701526044860152602085606481731f98431c8ad98523631ae4a59f267346ea31f9845afa9485156101fc5788956101bb575b508416330361017957501561016b57610168933592610b75565b80f35b610168935060243592610b75565b5162461bcd60e51b8152602081870152600c60248201527f4e6f742074686520706f6f6c00000000000000000000000000000000000000006044820152606490fd5b9094506020813d6020116101f4575b816101d760209383610ad8565b810103126101f0575184811681036101f057933861014e565b8780fd5b3d91506101ca565b82513d8a823e3d90fd5b8480fd5b8380fd5b8280fd5b503461020e5760c036600319011261020e576001600160a01b039182610236610b10565b16938251809581957f70a082310000000000000000000000000000000000000000000000000000000091828452338685015260209889916024998a915afa928315610a235784936109f4575b506084358061076c57506102ac81610298610b26565b166102a1610b3c565b604435913390610b75565b846060826102b8610b3c565b168851928380927f0902f1ac0000000000000000000000000000000000000000000000000000000082525afa9081156107625785908692610708575b506dffffffffffffffffffffffffffff9182169116610311610b26565b838061031b610b10565b169116101561070357905b8261032f610b26565b168a848b61033b610b3c565b8c5194859384928b8452168d8301525afa80156106f957839088906106c4575b6103659250610b52565b801561065d578215801580610654575b156105ed576103e58083029280840482036105db578402029282840414821517156105c9576103e88085029485041417156105b75782018092116105a557811561059357046103c2610b26565b82806103cc610b10565b169116101561058c57845b826103e0610b3c565b168851918b83019267ffffffffffffffff938181108582111761057a578b52888152823b1561057657918b91898b61045c82968f51998a97889687957f022c0d9f000000000000000000000000000000000000000000000000000000008752860152840152336044840152608060648401526084830190610cdb565b03925af1801561056c57908a939291610543575b505061047a610b10565b169187875180948193825233898301525afa908115610539578391610507575b50915b508015610500576104ad91610b52565b925b60a43584106104c057505051908152f35b601e9085606494519362461bcd60e51b85528401528201527f5265616c20416d6f756e74203c204d696e696d756d20526563656976656400006044820152fd5b50926104af565b90508681813d8311610532575b61051e8183610ad8565b8101031261052d57513861049a565b600080fd5b503d610514565b85513d85823e3d90fd5b9080929693501161055a5786529287903880610470565b8782604188634e487b7160e01b835252fd5b88513d88823e3d90fd5b8880fd5b8c8a60418d634e487b7160e01b835252fd5b84906103d7565b8886601289634e487b7160e01b835252fd5b8886601189634e487b7160e01b835252fd5b898760118a634e487b7160e01b835252fd5b8a8860118b634e487b7160e01b835252fd5b8c8a60118d634e487b7160e01b835252fd5b60848960288d8f8e519362461bcd60e51b85528401528201527f556e697377617056324c6962726172793a20494e53554646494349454e545f4c60448201527f49515549444954590000000000000000000000000000000000000000000000006064820152fd5b50821515610375565b608488602b8c8e8d519362461bcd60e51b85528401528201527f556e697377617056324c6962726172793a20494e53554646494349454e545f4960448201527f4e5055545f414d4f554e540000000000000000000000000000000000000000006064820152fd5b50508a81813d83116106f2575b6106db8183610ad8565b810103126106ee5782610365915161035b565b8680fd5b503d6106d1565b89513d89823e3d90fd5b610326565b9150506060813d60601161075a575b8161072460609383610ad8565b810103126102065761073581610d1b565b876107418b8401610d1b565b92015163ffffffff81160361075657386102f4565b8580fd5b3d9150610717565b87513d87823e3d90fd5b6001036109b35761077b610b26565b8180610785610b10565b16911610801561099857856401000276ad5b8a846107a1610b3c565b168a51938480927fddca3f430000000000000000000000000000000000000000000000000000000082525afa9182156106f957908b939291889261095a575b5062ffffff856107ee610b3c565b1692866107f9610b26565b8d82610803610b10565b928983519b8c015216908901521660608701523360808701521660a085015260a0845260c084019284841067ffffffffffffffff85111761094857838b527f128acb080000000000000000000000000000000000000000000000000000000084523360c486015260e4850152604435610104850152841661012484015260a061014484015288908290818960bf19876108a0610164820182610cdb565b0301925af1801561056c579188918b9493610915575b5050506108c1610b10565b169187875180948193825233898301525afa9081156105395783916108e8575b509161049d565b90508681813d831161090e575b6108ff8183610ad8565b8101031261020e5751386108e1565b503d6108f5565b909180939450903d8411610940575b8161092e91610ad8565b8101031261020a5787908638806108b6565b3d9150610924565b8b8960418c634e487b7160e01b835252fd5b809250849193943d8311610991575b6109738183610ad8565b810103126106ee575162ffffff811681036106ee578a9291386107e0565b503d610969565b8573fffd8963efd1fc6a506488495d951d5263988d25610797565b6064856014898b8a519362461bcd60e51b85528401528201527f496e76616c696420706f6f6c2076617269616e740000000000000000000000006044820152fd5b9092508781813d8311610a1c575b610a0c8183610ad8565b8101031261020a57519138610282565b503d610a02565b86513d86823e3d90fd5b905083913461020e578060031936011261020e578335906001600160a01b03821680920361020a577fa9059cbb000000000000000000000000000000000000000000000000000000006020840152336024840152602435604484015260448352608083019083821067ffffffffffffffff831117610ab15761016894955052610be6565b602485604188634e487b7160e01b835252fd5b35906001600160a01b038216820361052d57565b90601f8019910116810190811067ffffffffffffffff821117610afa57604052565b634e487b7160e01b600052604160045260246000fd5b6024356001600160a01b038116810361052d5790565b6004356001600160a01b038116810361052d5790565b6064356001600160a01b038116810361052d5790565b91908203918211610b5f57565b634e487b7160e01b600052601160045260246000fd5b9290604051927f23b872dd0000000000000000000000000000000000000000000000000000000060208501526001600160a01b03809216602485015216604483015260648201526064815260a081019181831067ffffffffffffffff841117610afa57610be492604052610be6565b565b6001600160a01b031690600080826020829451910182865af13d15610ccf573d9067ffffffffffffffff8211610cbb5790610c439160405191610c336020601f19601f8401160184610ad8565b82523d84602084013e5b84610d36565b908151918215159283610c8c575b505050610c5b5750565b602490604051907f5274afe70000000000000000000000000000000000000000000000000000000082526004820152fd5b819293509060209181010312610cb7576020015190811591821503610cb45750388080610c51565b80fd5b5080fd5b602483634e487b7160e01b81526041600452fd5b610c4390606090610c3d565b919082519283825260005b848110610d07575050826000602080949584010152601f8019910116010190565b602081830181015184830182015201610ce6565b51906dffffffffffffffffffffffffffff8216820361052d57565b90610d755750805115610d4b57805190602001fd5b60046040517f1425ea42000000000000000000000000000000000000000000000000000000008152fd5b81511580610dc0575b610d86575090565b6024906001600160a01b03604051917f9996b315000000000000000000000000000000000000000000000000000000008352166004820152fd5b50803b15610d7e56fea2646970667358221220b4aac17a7b8f27154691ef1ddd0413eec81dde7ad9dc0552efb1dd2802cd10b364736f6c63430008170033")]
    contract SwapRouter {
        struct Params {
            address input_token;
            address output_token;
            uint256 amount_in;
            address pool;
            uint pool_variant;
            uint256 minimum_received;
        }
        function do_swap(Params calldata params) external returns (uint256 real_amount);
        function recover_erc20(address token, uint256 amount) external;
        
    }
}

/// Encodes the swap parameters needed for [SwapRouter] contract
pub fn encode_swap(params: SwapRouter::Params) -> Bytes {
    let contract = SwapRouter::do_swapCall {
        params: SwapRouter::Params {
            input_token: params.input_token,
            output_token: params.output_token,
            amount_in: params.amount_in,
            pool: params.pool,
            pool_variant: params.pool_variant,
            minimum_received: params.minimum_received,
        }
    };
    
    Bytes::from(contract.abi_encode())
}

pub fn decode_swap(output: Bytes) -> Result<U256, anyhow::Error> {
    let call = SwapRouter::do_swapCall::abi_decode_returns(&output, true)?;
    Ok(call.real_amount)
}

/// Deployed Bytecode of swap router contract
pub fn swap_router_bytecode() -> Bytecode {
    Bytecode::new_raw(SWAP_ROUTER_CODE.clone())
}